# Keep logs machine-friendly and English-only.
# Suppress non-HTTP method noise (e.g., TLS handshake bytes sent to HTTP port).
log_format structured_json escape=json
  '{"time":"$time_iso8601",'
  '"remote_addr":"$remote_addr",'
  '"request_method":"$request_method",'
  '"request_uri":"$request_uri",'
  '"status":$status,'
  '"bytes_sent":$bytes_sent,'
  '"referer":"$http_referer",'
  '"user_agent":"$http_user_agent",'
  '"scheme":"$scheme",'
  '"host":"$host",'
  '"upstream_addr":"$upstream_addr",'
  '"upstream_status":"$upstream_status",'
  '"request_time":$request_time}';

map $request_method $is_known_http_method {
  default 0;
  GET 1;
  HEAD 1;
  POST 1;
  PUT 1;
  PATCH 1;
  DELETE 1;
  OPTIONS 1;
}

server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  access_log /var/log/nginx/access.log structured_json if=$is_known_http_method;

  # Avoid absolute redirects that can accidentally switch scheme/port in proxy chains.
  absolute_redirect off;
  port_in_redirect off;

  location / {
    try_files $uri $uri/ /index.html;
  }

  # Docker DNS re-resolve for upstream container IP rotation.
  resolver 127.0.0.11 valid=10s ipv6=off;

  # Normalize /api without trailing slash at edge to avoid upstream redirect ambiguity.
  location = /api {
    return 308 /api/;
  }

  # Health check endpoint
  location /healthz {
    set $upstream http://linguisticnode-api:8000;
    proxy_pass $upstream;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/ {
    # Keep /api prefix and forward to backend
    set $upstream http://linguisticnode-api:8000;
    proxy_pass $upstream;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
